{% extends 'base.html.twig' %}

{% block title %}Dashboard Admin{% endblock %}

{% block body %}
<div class="container-fluid py-4">

    {# HEADER #}
 <div class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-center text-center text-md-start"
         style="background: linear-gradient(135deg, #9b0000ff, #ff0000ff); border-radius: .5rem;">
        
        <div class="mb-3 mb-md-0">
            <h1 class="fw-bold text-white mb-1"><i class="bi bi-speedometer2"></i> Dashboard Admin</h1>
            <p class="text-white-50 mb-0">Bienvenue {{ app.user.prenom }} {{ app.user.nom }}</p>
        </div>

        <div class="d-flex flex-column flex-sm-row gap-2">
            <a href="{{ path('app_user_edit', {id: app.user.id}) }}" 
               class="btn btn-light d-flex align-items-center justify-content-center">
                <i class="bi bi-person-gear me-2"></i> Modifier mon profil
            </a>
            <a href="{{ path('app_home') }}" 
               class="btn btn-outline-light d-flex align-items-center justify-content-center">
                <i class="bi bi-arrow-left me-2"></i> Retour
            </a>
        </div>
    </div>
</div>



    <div class="row g-4">

        {# === M√âDECINS === #}
        <div class="col-12">
            <div class="card shadow h-100">
                <div class="card-header bg-success text-white d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <h5 class="mb-0"><i class="bi bi-heart-pulse"></i> M√©decins</h5>
                    <input type="text" class="form-control form-control-sm search-input w-auto flex-grow-1 flex-md-grow-0" placeholder="üîç Rechercher...">
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle text-center">
                            <thead class="table-success">
                                <tr>
                                    <th>ID</th><th>Nom</th><th>Pr√©nom</th><th>Utilisateur</th>
                                    <th>Email</th><th>T√©l√©phone</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for medecin in medecins %}
                                <tr>
                                    <td>{{ medecin.id }}</td>
                                    <td>{{ medecin.nom }}</td>
                                    <td>{{ medecin.prenom }}</td>
                                    <td>{{ medecin.username }}</td>
                                    <td class="text-nowrap">{{ medecin.email }}</td>
                                    <td class="text-nowrap">{{ medecin.numTelephone }}</td>
                                    <td>
                                        <a href="{{ path('app_admin_delete_user', {id: medecin.id}) }}"
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('‚ö†Ô∏è Supprimer {{ medecin.username }} ?');">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <nav><ul class="pagination pagination-sm justify-content-center"></ul></nav>
                </div>
            </div>
        </div>

        {# === PATIENTS === #}
        <div class="col-12">
            <div class="card shadow h-100">
                <div class="card-header bg-primary text-white d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <h5 class="mb-0"><i class="bi bi-person-hearts"></i> Patients</h5>
                    <input type="text" class="form-control form-control-sm search-input w-auto flex-grow-1 flex-md-grow-0" placeholder="üîç Rechercher...">
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle text-center">
                            <thead class="table-primary">
                                <tr>
                                    <th>ID</th><th>Nom</th><th>Pr√©nom</th><th>Utilisateur</th>
                                    <th>Email</th><th>T√©l√©phone</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for patient in patients %}
                                <tr>
                                    <td>{{ patient.id }}</td>
                                    <td>{{ patient.nom }}</td>
                                    <td>{{ patient.prenom }}</td>
                                    <td>{{ patient.username }}</td>
                                    <td class="text-nowrap">{{ patient.email }}</td>
                                    <td class="text-nowrap">{{ patient.numTelephone }}</td>
                                    <td>
                                        <a href="{{ path('app_admin_delete_user', {id: patient.id}) }}"
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('‚ö†Ô∏è Supprimer {{ patient.username }} ?');">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <nav><ul class="pagination pagination-sm justify-content-center"></ul></nav>
                </div>
            </div>
        </div>

        {# === UTILISATEURS === #}
        <div class="col-12">
            <div class="card shadow h-100">
                <div class="card-header bg-warning text-dark d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <h5 class="mb-0"><i class="bi bi-people"></i> Utilisateurs</h5>
                    <input type="text" class="form-control form-control-sm search-input w-auto flex-grow-1 flex-md-grow-0" placeholder="üîç Rechercher...">
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle text-center">
                            <thead class="table-warning">
                                <tr>
                                    <th>ID</th><th>Nom</th><th>Pr√©nom</th><th>Utilisateur</th>
                                    <th>Email</th><th>T√©l√©phone</th><th>R√¥les</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for user in users %}
                                <tr>
                                    <td>{{ user.id }}</td>
                                    <td>{{ user.nom }}</td>
                                    <td>{{ user.prenom }}</td>
                                    <td>{{ user.username }}</td>
                                    <td class="text-nowrap">{{ user.email }}</td>
                                    <td class="text-nowrap">{{ user.numTelephone }}</td>
                                    <td>
                                        <a href="{{ path('app_admin_set_role', {id: user.id, role: 'ROLE_PATIENT'}) }}" class="btn btn-sm btn-primary">Patient</a>
                                        <a href="{{ path('app_admin_set_role', {id: user.id, role: 'ROLE_MEDECIN'}) }}" class="btn btn-sm btn-success">M√©decin</a>
                                        <a href="{{ path('app_admin_set_role', {id: user.id, role: 'ROLE_ADMIN'}) }}" class="btn btn-sm btn-dark">Admin</a>
                                    </td>
                                    <td>
                                        <a href="{{ path('app_admin_delete_user', {id: user.id}) }}"
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('‚ö†Ô∏è Supprimer {{ user.username }} ?');">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <nav><ul class="pagination pagination-sm justify-content-center"></ul></nav>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const rowsPerPage = 10;

    document.querySelectorAll('.card').forEach(card => {
        const table = card.querySelector('table');
        if (!table) return;

        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const searchInput = card.querySelector('.card-header .search-input');
        const pagination = card.querySelector('.pagination');
        let currentPage = 1;

        function renderTable() {
            const query = searchInput.value.toLowerCase();
            const filteredRows = rows.filter(r => r.innerText.toLowerCase().includes(query));

            const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;
            if (currentPage > totalPages) currentPage = totalPages;

            rows.forEach(r => r.style.display = 'none');
            filteredRows.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage)
                        .forEach(r => r.style.display = '');

            pagination.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = 'page-item ' + (i === currentPage ? 'active' : '');
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener('click', e => {
                    e.preventDefault();
                    currentPage = i;
                    renderTable();
                });
                pagination.appendChild(li);
            }
        }

        searchInput.addEventListener('input', () => {
            currentPage = 1;
            renderTable();
        });

        renderTable();
    });
});
</script>
{% endblock %}
